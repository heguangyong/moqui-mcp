<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd"
          package-name="moqui.mcp">

    <!-- Marketplace MCPå¯¹è¯å¤„ç†æœåŠ¡ -->
    <service verb="process" noun="MarketplaceMessage">
        <description>å¤„ç†marketplaceå¯¹è¯æ¶ˆæ¯</description>
        <in-parameters>
            <parameter name="sessionId" required="true"/>
            <parameter name="message" required="true"/>
            <parameter name="merchantId" required="true"/>
            <parameter name="messageType" default-value="user"/>
        </in-parameters>
        <out-parameters>
            <parameter name="aiResponse"/>
            <parameter name="intent"/>
            <parameter name="success"/>
            <parameter name="matches"/>
            <parameter name="listingId"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/MarketplaceMcpServices.groovy#processMarketplaceMessage"/>
        </actions>
    </service>

    <!-- åˆ›å»ºmarketplaceä¼šè¯ -->
    <service verb="create" noun="MarketplaceSession" authenticate="false">
        <description>åˆ›å»ºæ–°çš„marketplace AIå¯¹è¯ä¼šè¯</description>
        <in-parameters>
            <parameter name="sessionId"/>
            <parameter name="merchantId" required="true"/>
            <parameter name="initialContext"/>
        </in-parameters>
        <out-parameters>
            <parameter name="sessionId"/>
            <parameter name="status"/>
            <parameter name="message"/>
        </out-parameters>
        <actions>
            <log level="info" message="=== createMarketplaceSession æœåŠ¡è¢«è°ƒç”¨ ==="/>
            <set field="sessionId" from="sessionId ?: ('MKT_SESSION_' + System.currentTimeMillis())"/>
            <log level="info" message="Generated sessionId: ${sessionId}"/>
            <log level="info" message="merchantId: ${merchantId}"/>

            <if condition="!merchantId">
                <return error="true" message="ç¼ºå°‘å¿…å¡«å‚æ•°ï¼šmerchantId"/>
            </if>

            <!-- ä½¿ç”¨è„šæœ¬ç¦ç”¨æˆæƒæ£€æŸ¥ -->
            <script><![CDATA[
                // ç¦ç”¨æˆæƒæ£€æŸ¥
                ec.artifactExecution.disableAuthz()
                try {
                    // ç¡®ä¿merchantIdå¯¹åº”çš„Partyå­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
                    def existingParty = ec.entity.find("mantle.party.Party")
                        .condition("partyId", merchantId)
                        .one()

                    if (!existingParty) {
                        ec.logger.info("Creating Party for merchantId: ${merchantId}")
                        ec.service.sync().name("create#mantle.party.Party").parameters([
                            partyId: merchantId,
                            partyTypeEnumId: "PtyPerson",
                            disabled: "N"
                        ]).call()
                    }

                    // åˆ›å»ºä¼šè¯è®°å½•
                    ec.service.sync().name("create#mcp.dialog.McpDialogSession").parameters([
                        sessionId: sessionId,
                        customerId: merchantId,
                        merchantId: merchantId,
                        currentPhase: "marketplace",
                        sessionType: "MARKETPLACE",
                        status: "ACTIVE",
                        createdDate: ec.user.nowTimestamp,
                        lastModifiedDate: ec.user.nowTimestamp
                    ]).call()
                } finally {
                    // é‡æ–°å¯ç”¨æˆæƒæ£€æŸ¥
                    ec.artifactExecution.enableAuthz()
                }
            ]]></script>

            <log level="info" message="=== ä¼šè¯åˆ›å»ºæˆåŠŸï¼ŒsessionId: ${sessionId} ==="/>
            <set field="status" value="success"/>
            <set field="message" value="Marketplaceä¼šè¯åˆ›å»ºæˆåŠŸ"/>
        </actions>
    </service>

    <!-- è·å–marketplaceä¼šè¯ä¿¡æ¯ -->
    <service verb="get" noun="MarketplaceSession" authenticate="false">
        <description>è·å–marketplaceä¼šè¯è¯¦æƒ…</description>
        <in-parameters>
            <parameter name="sessionId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="session"/>
            <parameter name="recentMessages"/>
            <parameter name="messageCount"/>
        </out-parameters>
        <actions>
            <log level="info" message="=== getMarketplaceSession æœåŠ¡è¢«è°ƒç”¨ ==="/>
            <log level="info" message="sessionId: ${sessionId}"/>

            <if condition="!sessionId">
                <return error="true" message="ç¼ºå°‘å¿…å¡«å‚æ•°ï¼šsessionId"/>
            </if>

            <!-- ä½¿ç”¨è„šæœ¬ç¦ç”¨æˆæƒæ£€æŸ¥ -->
            <script><![CDATA[
                // ç¦ç”¨æˆæƒæ£€æŸ¥
                ec.artifactExecution.disableAuthz()
                try {
                    // è·å–ä¼šè¯ä¿¡æ¯
                    session = ec.entity.find("mcp.dialog.McpDialogSession")
                        .condition("sessionId", sessionId)
                        .one()

                    if (!session) {
                        ec.logger.info("ä¼šè¯ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºç»“æœï¼š${sessionId}")
                        // ä¸æ·»åŠ é”™è¯¯æ¶ˆæ¯ï¼Œåªæ˜¯è¿”å›ç©ºçš„ç»“æœ
                        session = null
                        recentMessages = []
                        messageCount = 0
                        return
                    }

                    // è·å–æœ€è¿‘çš„å¯¹è¯è®°å½•
                    recentMessages = ec.entity.find("mcp.dialog.McpDialogMessage")
                        .condition("sessionId", sessionId)
                        .orderBy("-processedDate")
                        .limit(10)
                        .list()
                } finally {
                    // é‡æ–°å¯ç”¨æˆæƒæ£€æŸ¥
                    ec.artifactExecution.enableAuthz()
                }
            ]]></script>

            <set field="messageCount" from="recentMessages?.size() ?: 0"/>

            <log level="info" message="=== è·å–ä¼šè¯æˆåŠŸï¼ŒmessageCount: ${messageCount} ==="/>
        </actions>
    </service>

    <!-- æ›´æ–°marketplaceä¼šè¯ -->
    <service verb="update" noun="MarketplaceSession" authenticate="false">
        <description>æ›´æ–°marketplaceä¼šè¯ä¿¡æ¯</description>
        <in-parameters>
            <parameter name="sessionId" required="true"/>
            <parameter name="currentPhase"/>
            <parameter name="context"/>
            <parameter name="status"/>
            <parameter name="lastListingId"/>
            <parameter name="preferredCategories"/>
        </in-parameters>
        <out-parameters>
            <parameter name="sessionId"/>
            <parameter name="status"/>
            <parameter name="message"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/MarketplaceMcpServices.groovy#updateMarketplaceSession"/>
        </actions>
    </service>

    <!-- èŠå¤©æ¶ˆæ¯å¤„ç†ï¼ˆç®€åŒ–æ¥å£ï¼‰ -->
    <service verb="chat" noun="Message" authenticate="false">
        <description>å¤„ç†marketplaceèŠå¤©æ¶ˆæ¯</description>
        <in-parameters>
            <parameter name="sessionId" required="true"/>
            <parameter name="message" required="true"/>
            <parameter name="merchantId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="aiResponse"/>
            <parameter name="intent"/>
            <parameter name="success"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <log level="info" message="=== chatMessage æœåŠ¡è¢«è°ƒç”¨ ==="/>
            <log level="info" message="sessionId: ${sessionId}, message: ${message}, merchantId: ${merchantId}"/>

            <if condition="!sessionId || !message || !merchantId">
                <return error="true" message="ç¼ºå°‘å¿…å¡«å‚æ•°ï¼šsessionId, message, merchantId"/>
            </if>

            <!-- åˆ†ææ¶ˆæ¯æ„å›¾ -->
            <set field="lowerMessage" from="message.toLowerCase()"/>
            <if condition="lowerMessage.contains('ä¾›åº”') || lowerMessage.contains('å‘å¸ƒ')">
                <set field="intent" value="SUPPLY_CREATION"/>
            <else-if condition="lowerMessage.contains('éœ€æ±‚') || lowerMessage.contains('é‡‡è´­')">
                <set field="intent" value="DEMAND_CREATION"/>
            </else-if>
            <else-if condition="lowerMessage.contains('åŒ¹é…') || lowerMessage.contains('åˆ†æ')">
                <set field="intent" value="MATCHING_ANALYSIS"/>
            </else-if>
            <else-if condition="lowerMessage.contains('ç»Ÿè®¡') || lowerMessage.contains('æ•°æ®')">
                <set field="intent" value="DATA_STATISTICS"/>
            </else-if>
            <else>
                <set field="intent" value="GENERAL_INQUIRY"/>
            </else>
            </if>

            <!-- ç”ŸæˆAIå“åº” -->
            <if condition="intent == 'SUPPLY_CREATION'">
                <set field="aiResponse" value="æˆ‘æ¥å¸®æ‚¨åˆ›å»ºä¾›åº”ä¿¡æ¯ï¼è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š&#10;1. äº§å“åç§°&#10;2. ç±»åˆ«&#10;3. æ•°é‡&#10;4. ä»·æ ¼&#10;5. è”ç³»æ–¹å¼&#10;&#10;æ‚¨å¯ä»¥è¯´ï¼šæˆ‘è¦å‘å¸ƒé’¢æä¾›åº”100å¨å•ä»·4500å…ƒ"/>
            <else-if condition="intent == 'DEMAND_CREATION'">
                <set field="aiResponse" value="æˆ‘æ¥å¸®æ‚¨åˆ›å»ºéœ€æ±‚ä¿¡æ¯ï¼è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š&#10;1. äº§å“åç§°&#10;2. ç±»åˆ«&#10;3. éœ€æ±‚æ•°é‡&#10;4. é¢„ç®—&#10;5. æœŸé™&#10;&#10;æ‚¨å¯ä»¥è¯´ï¼šæˆ‘éœ€è¦é’¢æ150å¨é¢„ç®—680000å…ƒ"/>
            </else-if>
            <else-if condition="intent == 'MATCHING_ANALYSIS'">
                <set field="aiResponse" value="æ­£åœ¨ä¸ºæ‚¨åˆ†æåŒ¹é…ç»“æœ...&#10;&#10;æ ¹æ®æ‚¨çš„å†å²æ•°æ®ï¼Œæˆ‘æ‰¾åˆ°äº†ä»¥ä¸‹åŒ¹é…æœºä¼šï¼š&#10;âœ… é«˜è´¨é‡é’¢æä¾›åº”å•†ï¼ˆåŒ¹é…åº¦ï¼š92%ï¼‰&#10;âœ… å»ºæé‡‡è´­éœ€æ±‚ï¼ˆåŒ¹é…åº¦ï¼š88%ï¼‰&#10;âœ… æœ¬åœ°åŒ–é…é€ä¼˜åŠ¿ï¼ˆåŒ¹é…åº¦ï¼š85%ï¼‰&#10;&#10;éœ€è¦æŸ¥çœ‹è¯¦ç»†åŒ¹é…æŠ¥å‘Šå—ï¼Ÿ"/>
            </else-if>
            <else-if condition="intent == 'DATA_STATISTICS'">
                <set field="aiResponse" value="ğŸ“Š æ‚¨çš„marketplaceæ•°æ®æ¦‚è§ˆï¼š&#10;&#10;ğŸ“ˆ æœ¬æœˆä¾›åº”å‘å¸ƒï¼š12æ¡&#10;ğŸ“‹ æœ¬æœˆéœ€æ±‚å‘å¸ƒï¼š8æ¡&#10;ğŸ¯ æˆåŠŸåŒ¹é…ï¼š15ä¸ª&#10;ğŸ’° äº¤æ˜“æ€»é¢ï¼šï¿¥456,800&#10;â­ å¹³å‡è¯„åˆ†ï¼š4.3/5.0&#10;&#10;éœ€è¦æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå—ï¼Ÿ"/>
            </else-if>
            <else>
                <set field="aiResponse" value="æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½marketplaceåŠ©æ‰‹ğŸ¤–&#10;&#10;æˆ‘å¯ä»¥å¸®æ‚¨ï¼š&#10;ğŸ”¹ å‘å¸ƒä¾›åº”/éœ€æ±‚ä¿¡æ¯&#10;ğŸ”¹ æ™ºèƒ½åŒ¹é…åˆ†æ&#10;ğŸ”¹ æ•°æ®ç»Ÿè®¡æŠ¥å‘Š&#10;ğŸ”¹ äº¤æ˜“æµç¨‹æŒ‡å¯¼&#10;&#10;è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ"/>
            </else>
            </if>

            <!-- ä½¿ç”¨è„šæœ¬ç¦ç”¨æˆæƒæ£€æŸ¥å¹¶ä¿å­˜å¯¹è¯è®°å½• -->
            <script><![CDATA[
                // ç¦ç”¨æˆæƒæ£€æŸ¥
                ec.artifactExecution.disableAuthz()
                try {
                    // æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
                    def existingSession = ec.entity.find("mcp.dialog.McpDialogSession")
                        .condition("sessionId", sessionId)
                        .one()

                    if (!existingSession) {
                        ec.logger.info("Session ${sessionId} does not exist, creating it...")

                        // ç¡®ä¿merchantIdå¯¹åº”çš„Partyå­˜åœ¨
                        def existingParty = ec.entity.find("mantle.party.Party")
                            .condition("partyId", merchantId)
                            .one()

                        if (!existingParty) {
                            ec.logger.info("Creating Party for merchantId: ${merchantId}")
                            ec.service.sync().name("create#mantle.party.Party").parameters([
                                partyId: merchantId,
                                partyTypeEnumId: "PtyPerson",
                                disabled: "N"
                            ]).call()
                        }

                        // åˆ›å»ºä¼šè¯è®°å½•
                        ec.service.sync().name("create#mcp.dialog.McpDialogSession").parameters([
                            sessionId: sessionId,
                            customerId: merchantId,
                            merchantId: merchantId,
                            currentPhase: "marketplace",
                            sessionType: "MARKETPLACE",
                            status: "ACTIVE",
                            createdDate: ec.user.nowTimestamp,
                            lastModifiedDate: ec.user.nowTimestamp
                        ]).call()

                        ec.logger.info("Session ${sessionId} created successfully")
                    }

                    // ä¿å­˜å¯¹è¯è®°å½•
                    ec.service.sync().name("create#mcp.dialog.McpDialogMessage").parameters([
                        sessionId: sessionId,
                        messageId: "MSG_${System.currentTimeMillis()}",
                        message: message,
                        aiResponse: aiResponse,
                        intent: intent,
                        messageType: "user",
                        processedDate: ec.user.nowTimestamp,
                        merchantId: merchantId
                    ]).call()
                } finally {
                    // é‡æ–°å¯ç”¨æˆæƒæ£€æŸ¥
                    ec.artifactExecution.enableAuthz()
                }
            ]]></script>

            <log level="info" message="=== æ¶ˆæ¯å¤„ç†æˆåŠŸï¼Œintent: ${intent} ==="/>
            <set field="success" value="true"/>
        </actions>
    </service>

    <!-- æ™ºèƒ½æ¨èæœåŠ¡ -->
    <service verb="get" noun="SmartRecommendations" authenticate="false">
        <description>è·å–å•†å®¶æ™ºèƒ½æ¨è</description>
        <in-parameters>
            <parameter name="merchantId" required="true"/>
            <parameter name="maxResults" type="Integer" default="5"/>
            <parameter name="minScore" type="BigDecimal" default="0.6"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="recommendations"/>
            <parameter name="totalCount"/>
            <parameter name="merchantId"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/MarketplaceMcpServices.groovy#getSmartRecommendations"/>
        </actions>
    </service>

    <!-- å•†å®¶è¡Œä¸ºåˆ†ææœåŠ¡ -->
    <service verb="analyze" noun="MerchantBehavior">
        <description>åˆ†æå•†å®¶è¡Œä¸ºå’Œæ´»è·ƒåº¦</description>
        <in-parameters>
            <parameter name="merchantId" required="true"/>
            <parameter name="days" type="Integer" default="30"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="merchantId"/>
            <parameter name="analyzePeriod"/>
            <parameter name="supplyCount"/>
            <parameter name="demandCount"/>
            <parameter name="chatCount"/>
            <parameter name="activityScore"/>
            <parameter name="activityLevel"/>
            <parameter name="analysis"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/MarketplaceMcpServices.groovy#analyzeMerchantBehavior"/>
        </actions>
    </service>

    <!-- Rocket.Chaté›†æˆæœåŠ¡ -->
    <service verb="process" noun="RocketChatWebhook">
        <description>å¤„ç†æ¥è‡ªRocket.Chatçš„Webhookæ¶ˆæ¯</description>
        <in-parameters>
            <parameter name="text"/>
            <parameter name="user" type="Map"/>
            <parameter name="channel" type="Map"/>
            <parameter name="timestamp"/>
            <parameter name="messageId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="sessionId"/>
            <parameter name="intent"/>
            <parameter name="action"/>
            <parameter name="messageSent"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/RocketChatServices.groovy#processRocketChatWebhook"/>
        </actions>
    </service>

    <!-- å‘é€æ¶ˆæ¯åˆ°Rocket.Chat -->
    <service verb="send" noun="RocketChatMessage">
        <description>å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„Rocket.Chaté¢‘é“</description>
        <in-parameters>
            <parameter name="channelId" required="true"/>
            <parameter name="message" required="true"/>
            <parameter name="username"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="channelId"/>
            <parameter name="message"/>
            <parameter name="sent"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/RocketChatServices.groovy#sendMessageToRocketChat"/>
        </actions>
    </service>

    <!-- è·å–Rocket.Chaté›†æˆçŠ¶æ€ -->
    <service verb="get" noun="RocketChatStatus">
        <description>æ£€æŸ¥Rocket.Chaté›†æˆçŠ¶æ€å’Œé…ç½®</description>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="configured"/>
            <parameter name="rocketchatUrl"/>
            <parameter name="botUsername"/>
            <parameter name="status"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/RocketChatServices.groovy#getRocketChatStatus"/>
        </actions>
    </service>

    <!-- å‘é€marketplaceé€šçŸ¥ -->
    <service verb="send" noun="MarketplaceNotification">
        <description>é€šè¿‡Rocket.Chatå‘é€marketplaceé€šçŸ¥</description>
        <in-parameters>
            <parameter name="userId" required="true"/>
            <parameter name="notificationType" required="true"/>
            <parameter name="matchId"/>
            <parameter name="productName"/>
            <parameter name="matchScore"/>
            <parameter name="contactName"/>
            <parameter name="orderId"/>
            <parameter name="status"/>
            <parameter name="message"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="userId"/>
            <parameter name="notificationType"/>
            <parameter name="message"/>
            <parameter name="channelId"/>
            <parameter name="sent"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/RocketChatServices.groovy#sendMarketplaceNotification"/>
        </actions>
    </service>

    <!-- Telegram æ¶ˆæ¯å¤„ç†å…¥å£ -->
    <service verb="handle" noun="TelegramMessage" authenticate="false" type="script"
             location="component://moqui-mcp/src/main/groovy/TelegramServices.groovy">
        <in-parameters>
            <parameter name="update" type="Map"/>
            <parameter name="message" type="Map"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
            <parameter name="aiResponse"/>
            <parameter name="chatId"/>
            <parameter name="intent"/>
            <parameter name="matches" type="List"/>
            <parameter name="error"/>
            <parameter name="response" type="Map"/>
        </out-parameters>
    </service>

    <service verb="classify" noun="UserIntent" authenticate="false">
        <description>Telegram/MCPå…±ç”¨ï¼šè°ƒç”¨ä¸šåŠ¡æ„å›¾åˆ†ç±»</description>
        <implements service="mcp.routing.classify#UserIntent"/>
    </service>

    <!-- è¯­éŸ³æ¶ˆæ¯å¤„ç†æœåŠ¡ -->
    <service verb="process" noun="VoiceMessage" authenticate="false">
        <description>å¤„ç†è¯­éŸ³æ¶ˆæ¯è½¬æ–‡å­—å’Œæ™ºèƒ½å›å¤</description>
        <in-parameters>
            <parameter name="messageType" required="true"/>
            <parameter name="attachmentInfo" type="Map" required="true"/>
            <parameter name="sessionId"/>
            <parameter name="merchantId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
            <parameter name="aiResponse"/>
            <parameter name="intent"/>
            <parameter name="transcribedText"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                try {
                    ec.logger.info("Processing voice message: ${messageType}, fileId: ${attachmentInfo?.fileId}")

                    // ç›´æ¥è°ƒç”¨Javaç±»å¤„ç†è¯­éŸ³æ¶ˆæ¯
                    def marketplaceService = new org.moqui.mcp.MarketplaceMcpService(ec)

                    def parameters = [
                        sessionId: sessionId ?: "voice_session_${System.currentTimeMillis()}",
                        message: "[Voice Message]",
                        merchantId: merchantId ?: "voice_user_${System.currentTimeMillis()}",
                        messageType: messageType,
                        attachmentInfo: attachmentInfo
                    ]

                    def result = marketplaceService.processMarketplaceMessage(parameters)

                    success = result.success ?: false
                    aiResponse = result.aiResponse
                    intent = result.intent
                    transcribedText = result.transcribedText

                    ec.logger.info("Voice message processing result: success=${success}, intent=${intent}")

                } catch (Exception e) {
                    ec.logger.error("Error in voice message processing service: ${e.message}", e)
                    success = false
                    error = e.message
                    aiResponse = "ğŸ™ï¸ è¯­éŸ³æ¶ˆæ¯å¤„ç†å‡ºé”™ï¼Œè¯·ç”¨æ–‡å­—æè¿°æ‚¨çš„éœ€æ±‚ã€‚"
                }
            ]]></script>
        </actions>
    </service>

    <!-- æ‰‹åŠ¨å‘é€Telegramæ¶ˆæ¯ -->
    <service verb="send" noun="TelegramMessage">
        <description>ä»ç®¡ç†åå°å‘Telegramä¼šè¯å‘é€æ¶ˆæ¯å¹¶è®°å½•æ—¥å¿—</description>
        <in-parameters>
            <parameter name="sessionId" required="true"/>
            <parameter name="messageText" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success" type="Boolean"/>
            <parameter name="error"/>
            <parameter name="responseBody"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                import groovy.json.JsonOutput
                import java.net.URI
                import java.net.http.HttpClient
                import java.net.http.HttpRequest
                import java.net.http.HttpResponse
                import java.time.Duration

                success = false
                String trimmedMessage = messageText?.trim()
                if (!trimmedMessage) {
                    error = "æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º"
                    ec.message.addError(error)
                    return
                }

                def sessionValue = ec.entity.find("mcp.dialog.McpDialogSession")
                    .condition("sessionId", sessionId)
                    .disableAuthz()
                    .one()

                if (!sessionValue) {
                    error = "æœªæ‰¾åˆ°å¯¹åº”ä¼šè¯: ${sessionId}"
                    ec.message.addError(error)
                    return
                }

                String chatId = sessionId
                if (chatId.startsWith("telegram_")) {
                    chatId = chatId.substring("telegram_".length())
                }
                if (!chatId) {
                    error = "æ— æ³•è§£æTelegramèŠå¤©ID"
                    ec.message.addError(error)
                    return
                }

                String botToken = System.getProperty("telegram.bot.token") ?:
                                  System.getProperty("mcp.telegram.bot.token") ?:
                                  System.getenv("TELEGRAM_BOT_TOKEN") ?:
                                  ec.ecfi.getConfValue("telegram.bot.token")
                if (!botToken) {
                    error = "æœªé…ç½®Telegram Bot Token"
                    ec.logger.warn(error)
                    ec.message.addError(error)
                    return
                }

                HttpClient client = HttpClient.newBuilder()
                    .connectTimeout(Duration.ofSeconds(20))
                    .build()

                Map requestPayload = [
                    chat_id   : chatId,
                    text      : trimmedMessage,
                    parse_mode: "Markdown"
                ]
                String requestBody = JsonOutput.toJson(requestPayload)

                HttpRequest httpRequest = HttpRequest.newBuilder()
                    .uri(URI.create("https://api.telegram.org/bot${botToken}/sendMessage"))
                    .header("Content-Type", "application/json")
                    .POST(HttpRequest.BodyPublishers.ofString(requestBody))
                    .timeout(Duration.ofSeconds(30))
                    .build()

                HttpResponse<String> httpResponse
                try {
                    httpResponse = client.send(httpRequest, HttpResponse.BodyHandlers.ofString())
                } catch (Exception sendException) {
                    error = "å‘é€Telegramæ¶ˆæ¯å¤±è´¥: ${sendException.message}"
                    ec.logger.error("å‘é€Telegramæ¶ˆæ¯å¼‚å¸¸", sendException)
                    ec.message.addError(error)
                    return
                }

                responseBody = httpResponse?.body()
                if (!httpResponse || httpResponse.statusCode() != 200) {
                    error = "Telegramè¿”å›é”™è¯¯: HTTP ${httpResponse?.statusCode()}"
                    ec.logger.warn("Telegramå‘é€å¤±è´¥ï¼Œstatus=${httpResponse?.statusCode()}, body=${responseBody}")
                    ec.message.addError(error)
                    return
                }

                // è®°å½•æ¶ˆæ¯
                ec.service.sync().name("create#mcp.dialog.McpDialogMessage").parameters([
                    sessionId    : sessionId,
                    messageId    : "MSG_${System.currentTimeMillis()}",
                    messageType  : "assistant-ui",
                    aiResponse   : trimmedMessage,
                    merchantId   : sessionValue.merchantId,
                    processedDate: ec.user.nowTimestamp,
                    intent       : "MANUAL_REPLY"
                ]).disableAuthz().call()

                // æ›´æ–°ä¼šè¯æœ€è¿‘æ—¶é—´
                ec.service.sync().name("update#mcp.dialog.McpDialogSession").parameters([
                    sessionId        : sessionId,
                    lastModifiedDate : ec.user.nowTimestamp
                ]).disableAuthz().call()

                success = true
            ]]></script>
        </actions>
    </service>

    <!-- ==================== V2 ç»Ÿä¸€å“åº”æ ¼å¼æœåŠ¡ ==================== -->

    <service verb="chat" noun="MessageV2" authenticate="false" allow-remote="true">
        <description>AI chat service with unified response format V2</description>
        <in-parameters>
            <parameter name="message" type="String" required="true"/>
            <parameter name="sessionId" type="String" required="false"/>
            <parameter name="userType" type="String" default-value="anonymous"/>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // Call original chat service
                Map chatResult = ec.service.sync().name("moqui.mcp.chat#Message")
                    .parameters(context).call()

                // Wrap with unified response format
                Map wrapResult = ec.service.sync().name("mcp.ApiResponseServices.wrap#McpChatResponse")
                    .parameters([
                        chatData: chatResult,
                        sessionId: chatResult.sessionId ?: sessionId,
                        aiProvider: "GLM-4-Plus"
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

    <service verb="get" noun="SmartRecommendationsV2" authenticate="false" allow-remote="true">
        <description>Get smart recommendations with unified response format V2</description>
        <in-parameters>
            <parameter name="userId" type="String" required="false"/>
            <parameter name="category" type="String" required="false"/>
            <parameter name="limit" type="Integer" default-value="10"/>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // Call original recommendations service
                Map recsResult = ec.service.sync().name("moqui.mcp.get#SmartRecommendations")
                    .parameters(context).call()

                // Wrap with unified response format
                Map wrapResult = ec.service.sync().name("mcp.ApiResponseServices.wrap#McpApiResponse")
                    .parameters([
                        data: [recommendations: recsResult.recommendations ?: []],
                        success: true,
                        message: "æ™ºèƒ½æ¨èè·å–æˆåŠŸ"
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

    <service verb="get" noun="DialogSessionsV2" authenticate="false" allow-remote="true">
        <description>Get dialog sessions with unified response format V2</description>
        <in-parameters>
            <parameter name="userId" type="String" required="false"/>
            <parameter name="merchantId" type="String" required="false"/>
            <parameter name="pageIndex" type="Integer" default-value="0"/>
            <parameter name="pageSize" type="Integer" default-value="20"/>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // Mock session data for now since entity is missing
                List sessions = []
                if (merchantId) {
                    sessions.add([
                        sessionId: "SESS_${merchantId}_${System.currentTimeMillis()}",
                        merchantId: merchantId,
                        status: "ACTIVE",
                        lastModified: ec.user.nowTimestamp
                    ])
                }

                // Wrap with unified response format
                Map wrapResult = ec.service.sync().name("mcp.ApiResponseServices.wrap#McpApiResponse")
                    .parameters([
                        data: [sessions: sessions],
                        success: true,
                        message: "å¯¹è¯ä¼šè¯åˆ—è¡¨è·å–æˆåŠŸ"
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

    <service verb="create" noun="MarketplaceSessionV2" authenticate="false" allow-remote="true">
        <description>Create marketplace session with unified response format V2</description>
        <in-parameters>
            <parameter name="merchantId" type="String" required="true"/>
            <parameter name="userType" type="String" default-value="merchant"/>
        </in-parameters>
        <out-parameters>
            <parameter name="response" type="Map"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                // Call original create session service
                Map sessionResult = ec.service.sync().name("moqui.mcp.create#MarketplaceSession")
                    .parameters(context).call()

                // Wrap with unified response format
                Map wrapResult = ec.service.sync().name("mcp.ApiResponseServices.wrap#McpApiResponse")
                    .parameters([
                        data: [sessionId: sessionResult.sessionId],
                        success: sessionResult.success,
                        message: "ä¼šè¯åˆ›å»ºæˆåŠŸ",
                        sessionId: sessionResult.sessionId,
                        aiProvider: "GLM-4-Plus"
                    ]).call()

                response = wrapResult.response
            ]]></script>
        </actions>
    </service>

</services>
