<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd"
          package-name="moqui.mcp">

    <!-- Marketplace MCPå¯¹è¯å¤„ç†æœåŠ¡ -->
    <service verb="process" noun="MarketplaceMessage">
        <description>å¤„ç†marketplaceå¯¹è¯æ¶ˆæ¯</description>
        <in-parameters>
            <parameter name="sessionId" required="true"/>
            <parameter name="message" required="true"/>
            <parameter name="merchantId" required="true"/>
            <parameter name="messageType" default-value="user"/>
        </in-parameters>
        <out-parameters>
            <parameter name="aiResponse"/>
            <parameter name="intent"/>
            <parameter name="success"/>
            <parameter name="matches"/>
            <parameter name="listingId"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/MarketplaceMcpServices.groovy#processMarketplaceMessage"/>
        </actions>
    </service>

    <!-- åˆ›å»ºmarketplaceä¼šè¯ -->
    <service verb="create" noun="MarketplaceSession" authenticate="false">
        <description>åˆ›å»ºæ–°çš„marketplace AIå¯¹è¯ä¼šè¯</description>
        <in-parameters>
            <parameter name="sessionId"/>
            <parameter name="merchantId" required="true"/>
            <parameter name="initialContext"/>
        </in-parameters>
        <out-parameters>
            <parameter name="sessionId"/>
            <parameter name="status"/>
            <parameter name="message"/>
        </out-parameters>
        <actions>
            <log level="info" message="=== createMarketplaceSession æœåŠ¡è¢«è°ƒç”¨ ==="/>
            <set field="sessionId" from="sessionId ?: ('MKT_SESSION_' + System.currentTimeMillis())"/>
            <log level="info" message="Generated sessionId: ${sessionId}"/>
            <log level="info" message="merchantId: ${merchantId}"/>

            <if condition="!merchantId">
                <return error="true" message="ç¼ºå°‘å¿…å¡«å‚æ•°ï¼šmerchantId"/>
            </if>

            <!-- ä½¿ç”¨è„šæœ¬ç¦ç”¨æˆæƒæ£€æŸ¥ -->
            <script><![CDATA[
                // ç¦ç”¨æˆæƒæ£€æŸ¥
                ec.artifactExecution.disableAuthz()
                try {
                    // ç¡®ä¿merchantIdå¯¹åº”çš„Partyå­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
                    def existingParty = ec.entity.find("mantle.party.Party")
                        .condition("partyId", merchantId)
                        .one()

                    if (!existingParty) {
                        ec.logger.info("Creating Party for merchantId: ${merchantId}")
                        ec.service.sync().name("create#mantle.party.Party").parameters([
                            partyId: merchantId,
                            partyTypeEnumId: "PtyPerson",
                            disabled: "N"
                        ]).call()
                    }

                    // åˆ›å»ºä¼šè¯è®°å½•
                    ec.service.sync().name("create#mcp.dialog.McpDialogSession").parameters([
                        sessionId: sessionId,
                        customerId: merchantId,
                        merchantId: merchantId,
                        currentPhase: "marketplace",
                        sessionType: "MARKETPLACE",
                        status: "ACTIVE",
                        createdDate: ec.user.nowTimestamp,
                        lastModifiedDate: ec.user.nowTimestamp
                    ]).call()
                } finally {
                    // é‡æ–°å¯ç”¨æˆæƒæ£€æŸ¥
                    ec.artifactExecution.enableAuthz()
                }
            ]]></script>

            <log level="info" message="=== ä¼šè¯åˆ›å»ºæˆåŠŸï¼ŒsessionId: ${sessionId} ==="/>
            <set field="status" value="success"/>
            <set field="message" value="Marketplaceä¼šè¯åˆ›å»ºæˆåŠŸ"/>
        </actions>
    </service>

    <!-- è·å–marketplaceä¼šè¯ä¿¡æ¯ -->
    <service verb="get" noun="MarketplaceSession" authenticate="false">
        <description>è·å–marketplaceä¼šè¯è¯¦æƒ…</description>
        <in-parameters>
            <parameter name="sessionId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="session"/>
            <parameter name="recentMessages"/>
            <parameter name="messageCount"/>
        </out-parameters>
        <actions>
            <log level="info" message="=== getMarketplaceSession æœåŠ¡è¢«è°ƒç”¨ ==="/>
            <log level="info" message="sessionId: ${sessionId}"/>

            <if condition="!sessionId">
                <return error="true" message="ç¼ºå°‘å¿…å¡«å‚æ•°ï¼šsessionId"/>
            </if>

            <!-- ä½¿ç”¨è„šæœ¬ç¦ç”¨æˆæƒæ£€æŸ¥ -->
            <script><![CDATA[
                // ç¦ç”¨æˆæƒæ£€æŸ¥
                ec.artifactExecution.disableAuthz()
                try {
                    // è·å–ä¼šè¯ä¿¡æ¯
                    session = ec.entity.find("mcp.dialog.McpDialogSession")
                        .condition("sessionId", sessionId)
                        .one()

                    if (!session) {
                        ec.logger.warn("ä¼šè¯ä¸å­˜åœ¨ï¼š${sessionId}")
                        ec.message.addError("ä¼šè¯ä¸å­˜åœ¨")
                        return
                    }

                    // è·å–æœ€è¿‘çš„å¯¹è¯è®°å½•
                    recentMessages = ec.entity.find("mcp.dialog.McpDialogMessage")
                        .condition("sessionId", sessionId)
                        .orderBy("-processedDate")
                        .limit(10)
                        .list()
                } finally {
                    // é‡æ–°å¯ç”¨æˆæƒæ£€æŸ¥
                    ec.artifactExecution.enableAuthz()
                }
            ]]></script>

            <set field="messageCount" from="recentMessages?.size() ?: 0"/>

            <log level="info" message="=== è·å–ä¼šè¯æˆåŠŸï¼ŒmessageCount: ${messageCount} ==="/>
        </actions>
    </service>

    <!-- æ›´æ–°marketplaceä¼šè¯ -->
    <service verb="update" noun="MarketplaceSession" authenticate="false">
        <description>æ›´æ–°marketplaceä¼šè¯ä¿¡æ¯</description>
        <in-parameters>
            <parameter name="sessionId" required="true"/>
            <parameter name="currentPhase"/>
            <parameter name="context"/>
            <parameter name="status"/>
            <parameter name="lastListingId"/>
            <parameter name="preferredCategories"/>
        </in-parameters>
        <out-parameters>
            <parameter name="sessionId"/>
            <parameter name="status"/>
            <parameter name="message"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/MarketplaceMcpServices.groovy#updateMarketplaceSession"/>
        </actions>
    </service>

    <!-- èŠå¤©æ¶ˆæ¯å¤„ç†ï¼ˆç®€åŒ–æ¥å£ï¼‰ -->
    <service verb="chat" noun="Message" authenticate="false">
        <description>å¤„ç†marketplaceèŠå¤©æ¶ˆæ¯</description>
        <in-parameters>
            <parameter name="sessionId" required="true"/>
            <parameter name="message" required="true"/>
            <parameter name="merchantId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="aiResponse"/>
            <parameter name="intent"/>
            <parameter name="success"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <log level="info" message="=== chatMessage æœåŠ¡è¢«è°ƒç”¨ ==="/>
            <log level="info" message="sessionId: ${sessionId}, message: ${message}, merchantId: ${merchantId}"/>

            <if condition="!sessionId || !message || !merchantId">
                <return error="true" message="ç¼ºå°‘å¿…å¡«å‚æ•°ï¼šsessionId, message, merchantId"/>
            </if>

            <!-- åˆ†ææ¶ˆæ¯æ„å›¾ -->
            <set field="lowerMessage" from="message.toLowerCase()"/>
            <if condition="lowerMessage.contains('ä¾›åº”') || lowerMessage.contains('å‘å¸ƒ')">
                <set field="intent" value="SUPPLY_CREATION"/>
            <else-if condition="lowerMessage.contains('éœ€æ±‚') || lowerMessage.contains('é‡‡è´­')">
                <set field="intent" value="DEMAND_CREATION"/>
            </else-if>
            <else-if condition="lowerMessage.contains('åŒ¹é…') || lowerMessage.contains('åˆ†æ')">
                <set field="intent" value="MATCHING_ANALYSIS"/>
            </else-if>
            <else-if condition="lowerMessage.contains('ç»Ÿè®¡') || lowerMessage.contains('æ•°æ®')">
                <set field="intent" value="DATA_STATISTICS"/>
            </else-if>
            <else>
                <set field="intent" value="GENERAL_INQUIRY"/>
            </else>
            </if>

            <!-- ç”ŸæˆAIå“åº” -->
            <if condition="intent == 'SUPPLY_CREATION'">
                <set field="aiResponse" value="æˆ‘æ¥å¸®æ‚¨åˆ›å»ºä¾›åº”ä¿¡æ¯ï¼è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š&#10;1. äº§å“åç§°&#10;2. ç±»åˆ«&#10;3. æ•°é‡&#10;4. ä»·æ ¼&#10;5. è”ç³»æ–¹å¼&#10;&#10;æ‚¨å¯ä»¥è¯´ï¼šæˆ‘è¦å‘å¸ƒé’¢æä¾›åº”100å¨å•ä»·4500å…ƒ"/>
            <else-if condition="intent == 'DEMAND_CREATION'">
                <set field="aiResponse" value="æˆ‘æ¥å¸®æ‚¨åˆ›å»ºéœ€æ±‚ä¿¡æ¯ï¼è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š&#10;1. äº§å“åç§°&#10;2. ç±»åˆ«&#10;3. éœ€æ±‚æ•°é‡&#10;4. é¢„ç®—&#10;5. æœŸé™&#10;&#10;æ‚¨å¯ä»¥è¯´ï¼šæˆ‘éœ€è¦é’¢æ150å¨é¢„ç®—680000å…ƒ"/>
            </else-if>
            <else-if condition="intent == 'MATCHING_ANALYSIS'">
                <set field="aiResponse" value="æ­£åœ¨ä¸ºæ‚¨åˆ†æåŒ¹é…ç»“æœ...&#10;&#10;æ ¹æ®æ‚¨çš„å†å²æ•°æ®ï¼Œæˆ‘æ‰¾åˆ°äº†ä»¥ä¸‹åŒ¹é…æœºä¼šï¼š&#10;âœ… é«˜è´¨é‡é’¢æä¾›åº”å•†ï¼ˆåŒ¹é…åº¦ï¼š92%ï¼‰&#10;âœ… å»ºæé‡‡è´­éœ€æ±‚ï¼ˆåŒ¹é…åº¦ï¼š88%ï¼‰&#10;âœ… æœ¬åœ°åŒ–é…é€ä¼˜åŠ¿ï¼ˆåŒ¹é…åº¦ï¼š85%ï¼‰&#10;&#10;éœ€è¦æŸ¥çœ‹è¯¦ç»†åŒ¹é…æŠ¥å‘Šå—ï¼Ÿ"/>
            </else-if>
            <else-if condition="intent == 'DATA_STATISTICS'">
                <set field="aiResponse" value="ğŸ“Š æ‚¨çš„marketplaceæ•°æ®æ¦‚è§ˆï¼š&#10;&#10;ğŸ“ˆ æœ¬æœˆä¾›åº”å‘å¸ƒï¼š12æ¡&#10;ğŸ“‹ æœ¬æœˆéœ€æ±‚å‘å¸ƒï¼š8æ¡&#10;ğŸ¯ æˆåŠŸåŒ¹é…ï¼š15ä¸ª&#10;ğŸ’° äº¤æ˜“æ€»é¢ï¼šï¿¥456,800&#10;â­ å¹³å‡è¯„åˆ†ï¼š4.3/5.0&#10;&#10;éœ€è¦æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå—ï¼Ÿ"/>
            </else-if>
            <else>
                <set field="aiResponse" value="æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½marketplaceåŠ©æ‰‹ğŸ¤–&#10;&#10;æˆ‘å¯ä»¥å¸®æ‚¨ï¼š&#10;ğŸ”¹ å‘å¸ƒä¾›åº”/éœ€æ±‚ä¿¡æ¯&#10;ğŸ”¹ æ™ºèƒ½åŒ¹é…åˆ†æ&#10;ğŸ”¹ æ•°æ®ç»Ÿè®¡æŠ¥å‘Š&#10;ğŸ”¹ äº¤æ˜“æµç¨‹æŒ‡å¯¼&#10;&#10;è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ"/>
            </else>
            </if>

            <!-- ä½¿ç”¨è„šæœ¬ç¦ç”¨æˆæƒæ£€æŸ¥å¹¶ä¿å­˜å¯¹è¯è®°å½• -->
            <script><![CDATA[
                // ç¦ç”¨æˆæƒæ£€æŸ¥
                ec.artifactExecution.disableAuthz()
                try {
                    // ä¿å­˜å¯¹è¯è®°å½•
                    ec.service.sync().name("create#mcp.dialog.McpDialogMessage").parameters([
                        sessionId: sessionId,
                        messageId: "MSG_${System.currentTimeMillis()}",
                        message: message,
                        aiResponse: aiResponse,
                        intent: intent,
                        messageType: "user",
                        processedDate: ec.user.nowTimestamp,
                        merchantId: merchantId
                    ]).call()
                } finally {
                    // é‡æ–°å¯ç”¨æˆæƒæ£€æŸ¥
                    ec.artifactExecution.enableAuthz()
                }
            ]]></script>

            <log level="info" message="=== æ¶ˆæ¯å¤„ç†æˆåŠŸï¼Œintent: ${intent} ==="/>
            <set field="success" value="true"/>
        </actions>
    </service>

    <!-- æ™ºèƒ½æ¨èæœåŠ¡ -->
    <service verb="get" noun="SmartRecommendations">
        <description>è·å–å•†å®¶æ™ºèƒ½æ¨è</description>
        <in-parameters>
            <parameter name="merchantId" required="true"/>
            <parameter name="maxResults" type="Integer" default="5"/>
            <parameter name="minScore" type="BigDecimal" default="0.6"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="recommendations"/>
            <parameter name="totalCount"/>
            <parameter name="merchantId"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/MarketplaceMcpServices.groovy#getSmartRecommendations"/>
        </actions>
    </service>

    <!-- å•†å®¶è¡Œä¸ºåˆ†ææœåŠ¡ -->
    <service verb="analyze" noun="MerchantBehavior">
        <description>åˆ†æå•†å®¶è¡Œä¸ºå’Œæ´»è·ƒåº¦</description>
        <in-parameters>
            <parameter name="merchantId" required="true"/>
            <parameter name="days" type="Integer" default="30"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="merchantId"/>
            <parameter name="analyzePeriod"/>
            <parameter name="supplyCount"/>
            <parameter name="demandCount"/>
            <parameter name="chatCount"/>
            <parameter name="activityScore"/>
            <parameter name="activityLevel"/>
            <parameter name="analysis"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/MarketplaceMcpServices.groovy#analyzeMerchantBehavior"/>
        </actions>
    </service>

    <!-- Rocket.Chaté›†æˆæœåŠ¡ -->
    <service verb="process" noun="RocketChatWebhook">
        <description>å¤„ç†æ¥è‡ªRocket.Chatçš„Webhookæ¶ˆæ¯</description>
        <in-parameters>
            <parameter name="text"/>
            <parameter name="user" type="Map"/>
            <parameter name="channel" type="Map"/>
            <parameter name="timestamp"/>
            <parameter name="messageId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="sessionId"/>
            <parameter name="intent"/>
            <parameter name="action"/>
            <parameter name="messageSent"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/RocketChatServices.groovy#processRocketChatWebhook"/>
        </actions>
    </service>

    <!-- å‘é€æ¶ˆæ¯åˆ°Rocket.Chat -->
    <service verb="send" noun="RocketChatMessage">
        <description>å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„Rocket.Chaté¢‘é“</description>
        <in-parameters>
            <parameter name="channelId" required="true"/>
            <parameter name="message" required="true"/>
            <parameter name="username"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="channelId"/>
            <parameter name="message"/>
            <parameter name="sent"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/RocketChatServices.groovy#sendMessageToRocketChat"/>
        </actions>
    </service>

    <!-- è·å–Rocket.Chaté›†æˆçŠ¶æ€ -->
    <service verb="get" noun="RocketChatStatus">
        <description>æ£€æŸ¥Rocket.Chaté›†æˆçŠ¶æ€å’Œé…ç½®</description>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="configured"/>
            <parameter name="rocketchatUrl"/>
            <parameter name="botUsername"/>
            <parameter name="status"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/RocketChatServices.groovy#getRocketChatStatus"/>
        </actions>
    </service>

    <!-- å‘é€marketplaceé€šçŸ¥ -->
    <service verb="send" noun="MarketplaceNotification">
        <description>é€šè¿‡Rocket.Chatå‘é€marketplaceé€šçŸ¥</description>
        <in-parameters>
            <parameter name="userId" required="true"/>
            <parameter name="notificationType" required="true"/>
            <parameter name="matchId"/>
            <parameter name="productName"/>
            <parameter name="matchScore"/>
            <parameter name="contactName"/>
            <parameter name="orderId"/>
            <parameter name="status"/>
            <parameter name="message"/>
        </in-parameters>
        <out-parameters>
            <parameter name="success"/>
            <parameter name="userId"/>
            <parameter name="notificationType"/>
            <parameter name="message"/>
            <parameter name="channelId"/>
            <parameter name="sent"/>
            <parameter name="error"/>
        </out-parameters>
        <actions>
            <script location="component://moqui-mcp/src/main/groovy/RocketChatServices.groovy#sendMarketplaceNotification"/>
        </actions>
    </service>

</services>