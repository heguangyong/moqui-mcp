<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd"
          package-name="mcp.routing">

    <service verb="classify" noun="UserIntent" authenticate="false">
        <description>æ ¹æ®ç”¨æˆ·æ¶ˆæ¯ç²—åˆ†ä¸šåŠ¡åˆ†ç±»ä¸ç½®ä¿¡åº¦</description>
        <in-parameters>
            <parameter name="userMessage" required="true"/>
            <parameter name="messageType" default-value="text"/>
            <parameter name="chatId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="businessCategory"/>
            <parameter name="specificFunction"/>
            <parameter name="confidence" type="BigDecimal"/>
            <parameter name="extractedParameters" type="Map"/>
        </out-parameters>
        <actions><script><![CDATA[
            import java.math.BigDecimal
            import java.math.RoundingMode

            String raw = userMessage ?: ""
            String message = raw.toLowerCase()

            List<String> supplyKeywords = ["ä¾›åº”","éœ€æ±‚","é‡‡è´­","é”€å”®","æ‰¹å‘","é›¶å”®","åº“å­˜","ä»·æ ¼","ä¾›ç»™","æ±‚è´­","è®¢è´§","ä¹°","å–"]
            List<String> projectKeywords = ["é¡¹ç›®","ä»»åŠ¡","å›¢é˜Ÿ","è¿›åº¦","é‡Œç¨‹ç¢‘","æ­å»º","æ–½å·¥","è£…ä¿®","åä½œ","é˜¶æ®µ","éªŒæ”¶","ç‰ˆæœ¬","äº¤ä»˜","è®¡åˆ’"]
            List<String> ecommerceKeywords = ["è®¢å•","å•†åŸ","åº—é“º","å®¢æˆ·","ç‰©æµ","ä¿ƒé”€","è¥é”€","åº“å­˜","sku","å•†å“","ä¸Šæ¶","è¡¥è´§","é“ºè´§","æ¸ é“"]
            List<String> erpKeywords = ["è´¢åŠ¡","æŠ¥è¡¨","å®¡æ‰¹","æˆæœ¬","äººäº‹","ç”Ÿäº§","åˆ¶é€ ","è®¡åˆ’","æ’ç¨‹","ç‰©æ–™","ä¾›åº”é“¾","erp","å·¥å•"]
            List<String> ecommerceB2BKeywords = ["æ‰¹å‘","Bç«¯","æ¸ é“","åˆ†é”€","ç»é”€","è¡¥è´§","è¿›è´§","ä¾›è´§","å›¢è´­","åˆä¼™äºº","ä»£ç†","å•†æˆ·","é—¨åº—","å¯¹è´¦"]
            List<String> ecommerceProjectKeywords = ["é¡¹ç›®","å±•ä¼š","å±•å°","äº¤ä»˜","å®æ–½","è½åœ°","æ–¹æ¡ˆ","å¸ƒç½®","æ­å»º","å±•é™ˆ","è£…ä¿®"]
            List<String> ecommerceSocialKeywords = ["ç›´æ’­","çŸ­è§†é¢‘","è¾¾äºº","å¸¦è´§","ç§åŸŸ","ç¤¾ç¾¤","ç²‰ä¸","ç§è‰","å°çº¢ä¹¦","æŠ–éŸ³","å¿«æ‰‹"]

            int supplyScore = supplyKeywords.count { message.contains(it) }
            int projectScore = projectKeywords.count { message.contains(it) }
            int ecommerceScore = ecommerceKeywords.count { message.contains(it) }
            int erpScore = erpKeywords.count { message.contains(it) }

            Map<String, Integer> scoring = [
                SUPPLY_DEMAND_MATCHING: supplyScore,
                HIVEMIND_PROJECT      : projectScore,
                ECOMMERCE             : ecommerceScore,
                ERP                   : erpScore
            ]

            String category = "SUPPLY_DEMAND_MATCHING"
            Integer maxScore = 0
            scoring.each { key, val ->
                if (val > maxScore) {
                    maxScore = val
                    category = key
                }
            }

            String resolvedFunction = null
            String ecommerceIntent = null
            List<String> publishSupplyKeywords = ["å‘å¸ƒ","ä¸Šæ¶","ä¾›è´§","ä¾›åº”"]
            List<String> publishDemandKeywords = ["é‡‡è´­","æ±‚è´­","å¯»æ‰¾","éœ€æ±‚"]
            List<String> matchKeywords = ["åŒ¹é…","æ¨è","æ’®åˆ","æ™ºèƒ½"]

            if (category == "SUPPLY_DEMAND_MATCHING") {
                if (matchKeywords.any { message.contains(it) }) {
                    resolvedFunction = "FIND_MATCHES"
                } else if (publishSupplyKeywords.any { message.contains(it) }) {
                    resolvedFunction = "PUBLISH_SUPPLY"
                } else if (publishDemandKeywords.any { message.contains(it) }) {
                    resolvedFunction = "PUBLISH_DEMAND"
                } else {
                    resolvedFunction = "GENERAL_INQUIRY"
                }
            } else if (category == "HIVEMIND_PROJECT") {
                if (message.contains("åˆ›å»º") || message.contains("ç«‹é¡¹") || message.contains("new")) {
                    resolvedFunction = "PROJECT_CREATE"
                } else if (message.contains("åˆ—è¡¨") || message.contains("æ¦‚è§ˆ") || message.contains("overview")) {
                    resolvedFunction = "PROJECT_LIST"
                } else if (message.contains("ä»»åŠ¡") || message.contains("è¿›åº¦") || message.contains("çŠ¶æ€")) {
                    resolvedFunction = "PROJECT_STATUS"
                } else {
                    resolvedFunction = "PROJECT_GUIDE"
                }
            } else if (category == "ECOMMERCE") {
                if (message.contains("è®¢å•") || message.contains("é”€é‡") || message.contains("é”€å”®")) {
                    resolvedFunction = "ECOMMERCE_ORDER"
                } else if (message.contains("åº“å­˜") || message.contains("è¡¥è´§")) {
                    resolvedFunction = "ECOMMERCE_INVENTORY"
                } else if (message.contains("å•†å“") || message.contains("sku") || message.contains("ä¸Šæ¶")) {
                    resolvedFunction = "ECOMMERCE_PRODUCT"
                } else {
                    resolvedFunction = "ECOMMERCE_GUIDE"
                }
                if (ecommerceB2BKeywords.any { message.contains(it) }) {
                    ecommerceIntent = "B2B_PURCHASE"
                } else if (ecommerceProjectKeywords.any { message.contains(it) }) {
                    ecommerceIntent = "PROJECT_EXPANSION"
                } else if (ecommerceSocialKeywords.any { message.contains(it) }) {
                    ecommerceIntent = "SOCIAL_RETAIL"
                } else {
                    ecommerceIntent = "GENERAL_ECOMMERCE"
                }
                if ("B2B_PURCHASE".equals(ecommerceIntent) && resolvedFunction == "ECOMMERCE_PRODUCT") {
                    resolvedFunction = "ECOMMERCE_ORDER"
                }
                if ("PROJECT_EXPANSION".equals(ecommerceIntent) && resolvedFunction == "ECOMMERCE_ORDER") {
                    resolvedFunction = "ECOMMERCE_PRODUCT"
                }
            } else if (category == "ERP") {
                if (message.contains("ç”Ÿäº§") || message.contains("æ’äº§") || message.contains("å·¥å•")) {
                    resolvedFunction = "ERP_PRODUCTION"
                } else if (message.contains("è´¢åŠ¡") || message.contains("æˆæœ¬") || message.contains("æ ¸ç®—")) {
                    resolvedFunction = "ERP_FINANCE"
                } else {
                    resolvedFunction = "ERP_GUIDE"
                }
            }

            BigDecimal baseConfidence = maxScore ? new BigDecimal(Math.min(maxScore * 0.3 + 0.4, 0.95)) : new BigDecimal("0.4")
            if (category == "ECOMMERCE" && ecommerceIntent in ["B2B_PURCHASE","PROJECT_EXPANSION"]) {
                BigDecimal bonus = new BigDecimal("0.03")
                baseConfidence = baseConfidence.add(bonus)
                if (baseConfidence.compareTo(new BigDecimal("0.95")) > 0) {
                    baseConfidence = new BigDecimal("0.95")
                }
            }
            Map<String, Object> extracted = [
                    originalMessage : raw,
                    messageLength   : raw.length(),
                    containsNumber  : (raw =~ /\d+/).find(),
                    containsCurrency: raw.contains("Â¥") || raw.contains("ï¿¥") || raw.contains("å…ƒ") || raw.toLowerCase().contains("cny"),
                    detectedKeywords: (raw =~ /[\p{InCJKUnifiedIdeographs}]+/).collect { it }
            ]
            if (ecommerceIntent) {
                extracted.ecommerceIntent = ecommerceIntent
                extracted.intentTags = (extracted.intentTags ?: []) + ["ecommerce", ecommerceIntent.toLowerCase()]
            }

            businessCategory = category
            specificFunction = resolvedFunction
            confidence = baseConfidence
            extractedParameters = extracted
        ]]></script></actions>
    </service>

    <service verb="route" noun="ToBusinessModule" authenticate="false">
        <description>æ ¹æ®åˆ†ç±»ç»“æœè·¯ç”±åˆ°å…·ä½“ä¸šåŠ¡æ¨¡å—å¹¶ç»™å‡ºå›å¤å»ºè®®</description>
        <in-parameters>
            <parameter name="businessCategory" required="true"/>
            <parameter name="specificFunction"/>
            <parameter name="userMessage"/>
            <parameter name="chatId"/>
            <parameter name="sessionId"/>
            <parameter name="merchantId"/>
            <parameter name="extractedParameters" type="Map"/>
        </in-parameters>
        <out-parameters>
            <parameter name="routingResult" type="Map"/>
            <parameter name="nextAction"/>
            <parameter name="responseMessage"/>
        </out-parameters>
        <actions><script><![CDATA[
            import java.math.BigDecimal

            Map<String, Object> routeData = [:]
            String resolvedCategory = (businessCategory ?: "SUPPLY_DEMAND_MATCHING").toUpperCase()
            String resolvedFunction = (specificFunction ?: "GENERAL_INQUIRY").toUpperCase()
            String response = ""
            String nextActionFlag = "MAIN_MENU"

            Closure<String> formatPrice = { Object priceValue ->
                if (!priceValue) return ""
                BigDecimal bd
                if (priceValue instanceof BigDecimal) {
                    bd = (BigDecimal) priceValue
                } else {
                    bd = new BigDecimal(priceValue.toString())
                }
                return ec.l10n.formatCurrency(bd, "CNY")
            }

            switch (resolvedCategory) {
                case "SUPPLY_DEMAND_MATCHING":
                    nextActionFlag = "SUPPLY_MENU"
                    if (resolvedFunction == "FIND_MATCHES") {
                        try {
                            Map searchResult = ec.service.sync().name("marketplace.MarketplaceServices.search#Listings").parameters([
                                    pageSize: 5
                            ]).call()
                            List<Map> previewList = []
                            StringBuilder sb = new StringBuilder("ğŸ” ä¸ºæ‚¨æ‰¾åˆ°ä»¥ä¸‹ä¾›éœ€çº¿ç´¢ï¼š\n")
                            def listings = searchResult.listings instanceof List ? (List) searchResult.listings : []
                            int displayIndex = 0
                            listings.each { def value ->
                                if (displayIndex >= 5) return
                                Map item = value instanceof Map ? value : value?.getMap(false)
                                if (!item) return
                                previewList.add(item)
                                String title = item.title ?: item.listingId ?: "æœªå‘½åä¿¡æ¯"
                                String category = item.category ?: "--"
                                String priceText = item.priceMin ? formatPrice(item.priceMin) :
                                        (item.priceMax ? formatPrice(item.priceMax) : "ä»·æ ¼å¾…æ²Ÿé€š")
                                sb.append("${++displayIndex}. ${title} Â· ${category} Â· ${priceText}\n")
                            }
                            if (displayIndex == 0) {
                                response = "ğŸ” æš‚æœªæ£€ç´¢åˆ°åŒ¹é…ç»“æœï¼Œå¯ä»¥å°è¯•æä¾›æ›´å…·ä½“çš„å“ç±»ã€æ•°é‡æˆ–é¢„ç®—ä¿¡æ¯ã€‚"
                            } else {
                                response = sb.toString() + "\nå¯ç»§ç»­ç‚¹å‡»â€œå‘ç°åŒ¹é…â€æŸ¥çœ‹è¯¦æƒ…æˆ–æè¿°æ›´å…·ä½“çš„éœ€æ±‚ã€‚"
                            }
                            routeData.matchPreview = previewList
                        } catch (Exception e) {
                            ec.logger.warn("RoutingåŒ¹é…æ£€ç´¢å¤±è´¥: ${e.message}")
                            response = "åŒ¹é…æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚"
                        }
                    } else if (resolvedFunction in ["PUBLISH_SUPPLY","PUBLISH_DEMAND"]) {
                        boolean isSupply = resolvedFunction == "PUBLISH_SUPPLY"
                        response = isSupply ?
                                "ğŸ“¢ å‘å¸ƒä¾›åº”ï¼šè¯·ç›´æ¥æè¿°äº§å“ã€æ•°é‡ã€ä»·æ ¼ä¸åœ°åŒºï¼Œæˆ–ç‚¹å‡»â€œå‘å¸ƒä¿¡æ¯â€ä½¿ç”¨å¼•å¯¼è¡¨å•ã€‚" :
                                "ğŸ“¥ å‘å¸ƒéœ€æ±‚ï¼šè¯·å‘ŠçŸ¥æƒ³é‡‡è´­çš„å“ç±»ã€æ•°é‡ã€é¢„ç®—ä¸äº¤ä»˜åœ°ç‚¹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•å¹¶æ¨é€ç»™åˆé€‚çš„ä¾›åº”æ–¹ã€‚"
                    } else {
                        if (sessionId && merchantId && userMessage) {
                            try {
                                Map aiResult = ec.service.sync().name("moqui.mcp.process#MarketplaceMessage").parameters([
                                        sessionId : sessionId,
                                        merchantId: merchantId,
                                        message   : userMessage
                                ]).call()
                                response = (aiResult.aiResponse ?: "æˆ‘å·²è®°å½•æ‚¨çš„éœ€æ±‚ï¼Œç¨åä¼šç»™å‡ºå»ºè®®ã€‚").toString()
                                routeData.intent = aiResult.intent
                                routeData.matches = aiResult.matches
                            } catch (Exception e) {
                                ec.logger.warn("Routingè°ƒç”¨MarketplaceMessageå¤±è´¥: ${e.message}")
                                response = "æˆ‘å·²è®°å½•æ‚¨çš„éœ€æ±‚ï¼Œä¼šå°½å¿«ç»™å‡ºåŒ¹é…å»ºè®®ã€‚"
                            }
                        } else {
                            response = "è¯·æè¿°æƒ³å‘å¸ƒçš„ä¾›éœ€ä¿¡æ¯ï¼Œæˆ–ä½¿ç”¨èœå•ä¸­çš„åŠŸèƒ½ç»§ç»­æ“ä½œã€‚"
                        }
                    }
                    break

                case "HIVEMIND_PROJECT":
                    nextActionFlag = "PROJECT_MENU"
                    if (resolvedFunction in ["PROJECT_LIST","PROJECT_STATUS"]) {
                        try {
                            Map projectResult = ec.service.sync().name("marketplace.ProjectServices.get#ProjectList").parameters([
                                    limit: 5
                            ]).call()
                            List<Map> projects = projectResult.projects ?: []
                            routeData.projects = projects
                            if (!projects) {
                                response = "å½“å‰è¿˜æ²¡æœ‰é¡¹ç›®è®°å½•ï¼Œå¯é€šè¿‡ `/project create é¡¹ç›®åç§°` ç›´æ¥åˆ›å»ºã€‚"
                            } else {
                                StringBuilder sb = new StringBuilder("ğŸ—‚ï¸ æœ€è¿‘é¡¹ç›®ï¼š\n")
                                projects.eachWithIndex { Map proj, int idx ->
                                    sb.append("${idx + 1}. ${proj.projectName ?: proj.projectId} Â· çŠ¶æ€ ${proj.status ?: 'PLANNING'}\n")
                                }
                                sb.append("\nä½¿ç”¨ `/project status é¡¹ç›®ID` æŸ¥è¯¢å…·ä½“è¿›åº¦ã€‚")
                                response = sb.toString()
                            }
                        } catch (Exception e) {
                            ec.logger.warn("RoutingåŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥: ${e.message}")
                            response = "é¡¹ç›®åˆ—è¡¨æš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•æˆ–é€šè¿‡ `/project status` æŸ¥è¯¢ã€‚"
                        }
                    } else if (resolvedFunction == "PROJECT_CREATE") {
                        response = "ğŸ“‹ åˆ›å»ºé¡¹ç›®ï¼šå‘é€ `/project create é¡¹ç›®åç§°`ï¼Œæˆ–åœ¨æ§åˆ¶å°å¡«å†™æ›´è¯¦ç»†çš„é¢„ç®—ã€å‘¨æœŸã€å®¢æˆ·ä¿¡æ¯ã€‚"
                    } else {
                        response = "èœ‚å·¢é¡¹ç›®ç®¡ç†å¯ç”¨äºç‹¬ç«‹è·Ÿè¸ªé¡¹ç›®ã€ä»»åŠ¡ä¸æˆæœ¬ï¼Œç‚¹å‡»èœå•æŸ¥çœ‹æ›´å¤šæ“ä½œã€‚"
                    }
                    break

                case "ECOMMERCE":
                    nextActionFlag = "ECOMMERCE_MENU"
                    String ecommerceIntent = (extractedParameters?.ecommerceIntent ?: "GENERAL_ECOMMERCE").toUpperCase()
                    try {
                        Map recResult = ec.service.sync().name("marketplace.EcommerceServices.get#ProductRecommendations").parameters([
                                limit               : 5,
                                intentType          : ecommerceIntent,
                                preferredCategoryId : extractedParameters?.preferredCategoryId
                        ]).call()
                        List<Map> recs = recResult.recommendations instanceof List ? recResult.recommendations : []
                        routeData.recommendations = recs
                        routeData.recommendationIntent = ecommerceIntent
                        if (recs && !recs.isEmpty()) {
                            String tone
                            switch (ecommerceIntent) {
                                case "B2B_PURCHASE": tone = "ğŸ”— Bç«¯è¡¥è´§æ¨è"; break
                                case "PROJECT_EXPANSION": tone = "ğŸ—ï¸ é¡¹ç›®æ‰©å±•ç‰©æ–™æ¨è"; break
                                case "SOCIAL_RETAIL": tone = "ğŸ“£ è¥é”€çƒ­å–æ¨è"; break
                                default: tone = "ğŸ›ï¸ æ™ºèƒ½å•†å“æ¨è"; break
                            }
                            StringBuilder sb = new StringBuilder("${tone}\n")
                            recs.eachWithIndex { Map rec, int idx ->
                                String name = rec.productName ?: rec.ecommerceProductId ?: "æœªå‘½åå•†å“"
                                String priceText = rec.price ? formatPrice(rec.price) : "å¾…å®šä»·"
                                sb.append("${idx + 1}. ${name} Â· ${priceText}\n")
                                if (rec.avgRating) {
                                    BigDecimal rating = rec.avgRating instanceof BigDecimal ?
                                            (BigDecimal) rec.avgRating : new BigDecimal(rec.avgRating.toString())
                                    sb.append("   â­ï¸ ${rating.setScale(1, RoundingMode.HALF_UP)} /5 Â· è¯„ä»· ${rec.reviewCount ?: 0}\n")
                                }
                                if (rec.orderCount) {
                                    sb.append("   ğŸ“¦ ç´¯è®¡è®¢å• ${rec.orderCount}\n")
                                }
                                if (rec.recommendationSource) {
                                    sb.append("   æ¥æºï¼š${rec.recommendationSource}\n")
                                }
                            }
                            sb.append("\nå¯ä½¿ç”¨ `/product` æˆ– `/order` æŒ‡ä»¤ç»§ç»­æ“ä½œ")
                            if (ecommerceIntent == "PROJECT_EXPANSION") {
                                sb.append("ï¼Œè‹¥éœ€è·Ÿè¸ªé¡¹ç›®è¯·ä½¿ç”¨ `/project create` å»ºæ¡£")
                            }
                            sb.append("ã€‚")
                            response = sb.toString()
                        } else {
                            response = "ç”µå•†æ¨¡å—å·²å‡†å¤‡å°±ç»ªï¼Œè¯·å…ˆåˆ›å»ºå•†å“æˆ–äº§ç”Ÿè¯„ä»·åå†è·å–æ¨èã€‚"
                        }
                    } catch (Exception e) {
                        ec.logger.warn("Routingç”µå•†æ¨èå¤±è´¥: ${e.message}")
                        response = "ç”µå•†æ¨èæš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚"
                    }
                    break

                case "ERP":
                    nextActionFlag = "ERP_MENU"
                    response = "ğŸ’¼ å¤§ç†çŸ³ ERP æ¨¡å—æ­£åœ¨é€‚é…ç”Ÿäº§è®¡åˆ’ã€æˆæœ¬ä¸åº“å­˜æµç¨‹ï¼Œç¨åå°†å¼€æ”¾æµ‹è¯•å…¥å£ã€‚"
                    break

                default:
                    nextActionFlag = "MAIN_MENU"
                    response = "æˆ‘è¿˜åœ¨å­¦ä¹ å¦‚ä½•å¤„ç†è¯¥ç±»åˆ«çš„è¯·æ±‚ï¼Œè¯·å…ˆé€‰æ‹©å…·ä½“ä¸šåŠ¡åˆ†ç±»ã€‚"
                    break
            }

            routingResult = routeData
            nextAction = nextActionFlag
            responseMessage = response ?: "åŠŸèƒ½å»ºè®¾ä¸­ï¼Œç¨åä¸ºæ‚¨æä¾›æ›´å¤šæŒ‡å¼•ã€‚"
        ]]></script></actions>
    </service>

</services>
