<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <service verb="classify" noun="UserIntent" authenticate="false">
        <description>根据用户消息粗分业务分类与置信度</description>
        <in-parameters>
            <parameter name="userMessage" required="true"/>
            <parameter name="messageType" default-value="text"/>
            <parameter name="chatId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="businessCategory"/>
            <parameter name="specificFunction"/>
            <parameter name="confidence" type="BigDecimal"/>
            <parameter name="extractedParameters" type="Map"/>
        </out-parameters>
        <actions><script><![CDATA[
            import java.math.BigDecimal

            String message = (userMessage ?: "").toLowerCase()

            List<String> supplyKeywords = ["供应","需求","采购","销售","批发","零售","库存","价格","供给","求购","订货","买","卖"]
            List<String> projectKeywords = ["项目","任务","团队","进度","里程碑","搭建","施工","装修","协作","阶段","验收"]
            List<String> ecommerceKeywords = ["订单","商城","店铺","客户","物流","促销","营销","库存","SKU","商品"]
            List<String> erpKeywords = ["财务","报表","审批","成本","人事","生产","制造","计划","排程","物料","供应链"]

            int supplyScore = supplyKeywords.count { message.contains(it) }
            int projectScore = projectKeywords.count { message.contains(it) }
            int ecommerceScore = ecommerceKeywords.count { message.contains(it) }
            int erpScore = erpKeywords.count { message.contains(it) }

            Map<String, Integer> scoring = [
                SUPPLY_DEMAND_MATCHING: supplyScore,
                HIVEMIND_PROJECT      : projectScore,
                ECOMMERCE             : ecommerceScore,
                ERP                   : erpScore
            ]

            String category = "SUPPLY_DEMAND_MATCHING"
            Integer maxScore = 0
            scoring.each { key, val ->
                if (val > maxScore) {
                    maxScore = val
                    category = key
                }
            }

            BigDecimal baseConfidence = maxScore ? new BigDecimal(Math.min(maxScore * 0.3 + 0.4, 0.95)) : new BigDecimal("0.4")
            businessCategory = category
            specificFunction = null
            confidence = baseConfidence
            extractedParameters = [:]
        ]]></script></actions>
    </service>

</services>
